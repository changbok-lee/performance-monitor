name: Scheduled Performance Measurement

on:
  schedule:
    # Mobile: ë§¤ì¼ í•œêµ­ì‹œê°„ ìƒˆë²½ 1ì‹œ (UTC 16:00)
    - cron: '0 16 * * *'
    # Desktop: ë§¤ì¼ í•œêµ­ì‹œê°„ ìƒˆë²½ 2ì‹œ 30ë¶„ (UTC 17:30)
    - cron: '30 17 * * *'
  workflow_dispatch:
    inputs:
      network:
        description: 'Network type to measure'
        required: true
        default: 'Mobile'
        type: choice
        options:
          - Mobile
          - Desktop

jobs:
  measure:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd backend
          npm install

      - name: Determine network type
        id: network
        run: |
          # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ìž…ë ¥ê°’ ì‚¬ìš©
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.network }}" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Manual execution: ${{ github.event.inputs.network }}"
          else
            # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ ì‹œê°„ ê¸°ë°˜ ìžë™ ê²°ì •
            HOUR=$(date -u +%H)

            if [ "$HOUR" == "16" ]; then
              echo "type=Mobile" >> $GITHUB_OUTPUT
              echo "ðŸ“± Scheduled execution: Mobile (UTC 16:00)"
            elif [ "$HOUR" == "17" ]; then
              echo "type=Desktop" >> $GITHUB_OUTPUT
              echo "ðŸ’» Scheduled execution: Desktop (UTC 17:30)"
            else
              echo "type=Mobile" >> $GITHUB_OUTPUT
              echo "ðŸ“± Default: Mobile"
            fi
          fi

      - name: Display measurement info
        run: |
          echo "ðŸš€ Starting ${{ steps.network.outputs.type }} measurement"
          echo "ðŸ“… Time: $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸ”„ Trigger: ${{ github.event_name }}"
          echo "ðŸ’¾ Storage: Supabase"
          echo "â±ï¸  Timeout: 300 minutes"

      - name: Run measurement
        timeout-minutes: 300
        env:
          PAGESPEED_API_KEY: ${{ secrets.PAGESPEED_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          NETWORK_TYPE: ${{ steps.network.outputs.type }}
        run: |
          cd backend
          node run-measurement.js

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Measurement Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Network:** ${{ steps.network.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **Storage:** Supabase (Cloud DB)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **Measurement completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ë°ì´í„°ê°€ Supabaseì— ìžë™ ì €ìž¥ë˜ì—ˆìŠµë‹ˆë‹¤. ëŒ€ì‹œë³´ë“œì—ì„œ ìƒˆë¡œê³ ì¹¨í•˜ë©´ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Measurement failed. Check logs for details.**" >> $GITHUB_STEP_SUMMARY
          fi
