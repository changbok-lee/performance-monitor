name: Scheduled Performance Measurement

on:
  schedule:
    # Mobile: ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 1ì‹œ (UTC 16:00)
    - cron: '0 16 * * *'
    # Desktop: ë§¤ì¼ í•œêµ­ì‹œê°„ ì˜¤ì „ 2ì‹œ (UTC 17:00)
    - cron: '0 17 * * *'
  workflow_dispatch:

jobs:
  measure:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd backend
          npm install

      - name: Determine network type
        id: network
        run: |
          HOUR=$(date -u +%H)
          if [ "$HOUR" == "16" ]; then
            echo "type=Mobile" >> $GITHUB_OUTPUT
          else
            echo "type=Desktop" >> $GITHUB_OUTPUT
          fi

      - name: Display measurement info
        run: |
          echo "ðŸš€ Starting ${{ steps.network.outputs.type }} measurement"
          echo "ðŸ“… Time: $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "â±ï¸  Timeout: 300 minutes"

      - name: Run measurement
        timeout-minutes: 300
        env:
          PAGESPEED_API_KEY: ${{ secrets.PAGESPEED_API_KEY }}
          NETWORK_TYPE: ${{ steps.network.outputs.type }}
        run: |
          cd backend
          node run-measurement.js

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          echo "ðŸ“¥ Pulling latest changes..."
          git pull --rebase origin main || git pull origin main || true
          
          echo "ðŸ“Š Adding database changes..."
          git add backend/database/performance.db
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            echo "ðŸ’¾ Committing changes..."
            git commit -m "Auto-update: ${{ steps.network.outputs.type }} measurement $(date +'%Y-%m-%d %H:%M:%S')"
            
            echo "ðŸ“¤ Pushing changes..."
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            until git push origin main || [ $RETRY_COUNT -eq $MAX_RETRIES ]; do
              RETRY_COUNT=$((RETRY_COUNT+1))
              echo "âš ï¸  Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "ðŸ“¥ Pulling again..."
                git pull --rebase origin main || git pull origin main || true
                sleep 5
              fi
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Failed to push after $MAX_RETRIES attempts"
              exit 1
            else
              echo "âœ… Successfully pushed changes"
            fi
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Measurement Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Network:** ${{ steps.network.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f backend/database/performance.db ]; then
            DB_SIZE=$(du -h backend/database/performance.db | cut -f1)
            echo "- **Database Size:** $DB_SIZE" >> $GITHUB_STEP_SUMMARY
          fi