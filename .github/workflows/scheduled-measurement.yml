name: Scheduled Performance Measurement

on:
  schedule:
    # Mobile: ë§¤ì¼ í•œêµ­ì‹œê°„ ìƒˆë²½ 1ì‹œ (UTC 16:00)
    - cron: '0 16 * * *'
    # Desktop: ë§¤ì¼ í•œêµ­ì‹œê°„ ìƒˆë²½ 2ì‹œ 30ë¶„ (UTC 17:30)
    - cron: '30 17 * * *'
  workflow_dispatch:
    inputs:
      network:
        description: 'Network type to measure'
        required: true
        default: 'Mobile'
        type: choice
        options:
          - Mobile
          - Desktop

jobs:
  measure:
    runs-on: ubuntu-latest
    timeout-minutes: 300

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          cd backend
          npm install

      - name: Determine network type
        id: network
        run: |
          # ìˆ˜ë™ ì‹¤í–‰ ì‹œ ìž…ë ¥ê°’ ì‚¬ìš©
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.network }}" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Manual execution: ${{ github.event.inputs.network }}"
          else
            # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ ì‹œê°„ ê¸°ë°˜ ìžë™ ê²°ì •
            HOUR=$(date -u +%H)
            MINUTE=$(date -u +%M)
            
            if [ "$HOUR" == "16" ]; then
              echo "type=Mobile" >> $GITHUB_OUTPUT
              echo "ðŸ“± Scheduled execution: Mobile (UTC 16:00)"
            elif [ "$HOUR" == "17" ] && [ "$MINUTE" -ge "30" ]; then
              echo "type=Desktop" >> $GITHUB_OUTPUT
              echo "ðŸ’» Scheduled execution: Desktop (UTC 17:30)"
            else
              echo "type=Desktop" >> $GITHUB_OUTPUT
              echo "ðŸ’» Default execution: Desktop"
            fi
          fi

      - name: Display measurement info
        run: |
          echo "ðŸš€ Starting ${{ steps.network.outputs.type }} measurement"
          echo "ðŸ“… Time: $(date +'%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸ”„ Trigger: ${{ github.event_name }}"
          echo "â±ï¸  Timeout: 300 minutes"

      - name: Run measurement
        timeout-minutes: 300
        env:
          PAGESPEED_API_KEY: ${{ secrets.PAGESPEED_API_KEY }}
          NETWORK_TYPE: ${{ steps.network.outputs.type }}
        run: |
          cd backend
          node run-measurement.js

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Actions"
          
          echo "ðŸ“¥ Pulling latest changes..."
          git pull --rebase origin main || git pull origin main || echo "Pull completed with warnings"
          
          echo "ðŸ“Š Adding database changes..."
          git add backend/database/performance.db
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
          else
            echo "ðŸ’¾ Committing changes..."
            COMMIT_MSG="Auto-update: ${{ steps.network.outputs.type }} measurement $(date +'%Y-%m-%d %H:%M:%S')"
            git commit -m "$COMMIT_MSG"
            
            echo "ðŸ“¤ Pushing changes with retry logic..."
            MAX_RETRIES=5
            RETRY_COUNT=0
            PUSH_SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$PUSH_SUCCESS" = false ]; do
              if git push origin main; then
                echo "âœ… Successfully pushed on attempt $((RETRY_COUNT + 1))"
                PUSH_SUCCESS=true
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Push failed, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
                  echo "ðŸ“¥ Pulling latest changes before retry..."
                  git pull --rebase origin main || git pull origin main || echo "Pull completed with warnings"
                  sleep 5
                else
                  echo "âŒ Failed to push after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi

      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š Measurement Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Network:** ${{ steps.network.outputs.type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date +'%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f backend/database/performance.db ]; then
            DB_SIZE=$(du -h backend/database/performance.db | cut -f1)
            RECORD_COUNT=$(sqlite3 backend/database/performance.db "SELECT COUNT(*) FROM measurements;")
            echo "- **Database Size:** $DB_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Total Records:** $RECORD_COUNT" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **Measurement completed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **Measurement failed. Check logs for details.**" >> $GITHUB_STEP_SUMMARY
          fi